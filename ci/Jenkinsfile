pipeline {
    agent any
    
    environment {
        // Container configuration
        CONTAINER_NAME = 'video2md'
        IMAGE_NAME = 'video2md'
        
        // Port mapping: host_port:container_port
        HOST_PORT = '7860'
        CONTAINER_PORT = '7860'
        
        // Timezone configuration
        TZ = 'Australia/Sydney'
    }
    
    stages {
        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building Docker image: ${IMAGE_NAME}"
                    docker.build(IMAGE_NAME)
                }
            }
        }
        
        stage('Check Docker Container') {
            steps {
                script {
                    // Check if container with same name is running
                    def containerId = sh(
                        script: "docker ps -aq --filter name=^/${CONTAINER_NAME}\$",
                        returnStdout: true
                    ).trim()
                    
                    if (containerId) {
                        echo "Found existing container: ${containerId}"
                        // Stop and remove existing container
                        sh "docker stop ${CONTAINER_NAME}"
                        sh "docker rm ${CONTAINER_NAME}"
                        echo "Removed existing container"
                    } else {
                        echo "No existing container found"
                    }
                }
            }
        }
        
        stage('Run Docker Container') {
            steps {
                script {
                    echo "Starting new container: ${CONTAINER_NAME}"
                    sh """
                        docker run -d \
                        --name="${CONTAINER_NAME}" \
                        --net="bridge" \
                        -e TZ="${TZ}" \
                        -p "${HOST_PORT}:${CONTAINER_PORT}/tcp" \
                        -v \$(pwd)/input:/app/input \
                        -v \$(pwd)/output:/app/output \
                        -v \$(pwd)/models:/app/models \
                        -v \$(pwd)/.env:/app/.env:ro \
                        --restart unless-stopped \
                        "${IMAGE_NAME}"
                    """
                    echo "Container started successfully"
                }
            }
        }
        
        stage('Verify Container') {
            steps {
                script {
                    // Wait a few seconds for container to start
                    sleep 5
                    
                    // Check container status
                    def status = sh(
                        script: "docker inspect -f '{{.State.Running}}' ${CONTAINER_NAME}",
                        returnStdout: true
                    ).trim()
                    
                    if (status == 'true') {
                        echo "Container is running successfully"
                        // Show container logs
                        sh "docker logs ${CONTAINER_NAME}"
                    } else {
                        error "Container failed to start"
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "Deployment successful! Video2MD is available at http://localhost:${HOST_PORT}"
        }
        failure {
            echo "Deployment failed. Check the logs for details."
            // Optionally clean up failed container
            script {
                sh "docker rm -f ${CONTAINER_NAME} || true"
            }
        }
    }
}
