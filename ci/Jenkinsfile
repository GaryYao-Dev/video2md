pipeline {
    agent any
    
    environment {
        // Container configuration
        CONTAINER_NAME = 'video2md'
        IMAGE_NAME = 'video2md'
        
        // Port mapping: host_port:container_port
        HOST_PORT = '7860'
        CONTAINER_PORT = '7860'
        
        // Timezone configuration
        TZ = 'Australia/Sydney'
        
        // Unraid persistent directory
        HOST_DATA_DIR = '/mnt/user/appdata/video2md'
    }
    
    stages {
        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building Docker image: ${IMAGE_NAME}"
                    docker.build(IMAGE_NAME)
                }
            }
        }
        
        stage('Stop & Remove Existing Container') {
            steps {
                script {
                    echo "Checking for existing container: ${CONTAINER_NAME}"
                    def existing = sh(
                        script: "docker ps -aq --filter name=^/${CONTAINER_NAME}\$",
                        returnStdout: true
                    ).trim()
                    
                    if (existing) {
                        echo "Stopping existing container..."
                        sh "docker stop ${CONTAINER_NAME} || true"
                        echo "Removing existing container..."
                        sh "docker rm ${CONTAINER_NAME} || true"
                    } else {
                        echo "No existing container found."
                    }
                }
            }
        }
        
        stage('Run Docker Container') {
            steps {
                script {
                    echo "Starting new container: ${CONTAINER_NAME}"
                    sh """
                        docker run -d \
                        --name="${CONTAINER_NAME}" \
                        --net="bridge" \
                        --restart unless-stopped \
                        -e TZ="${TZ}" \
                        -e HOST_OS="Unraid" \
                        -p "${HOST_PORT}:${CONTAINER_PORT}/tcp" \
                        -v "${HOST_DATA_DIR}/input:/app/input" \
                        -v "${HOST_DATA_DIR}/output:/app/output" \
                        -v "${HOST_DATA_DIR}/models:/app/models" \
                        -v "${HOST_DATA_DIR}/.env:/app/.env:ro" \
                        "${IMAGE_NAME}"
                    """
                    echo "Container started successfully"
                }
            }
        }
        
        stage('Verify Container') {
            steps {
                script {
                    // Wait a few seconds for container to start
                    sleep 5
                    
                    // Check container status
                    def status = sh(
                        script: "docker inspect -f '{{.State.Running}}' ${CONTAINER_NAME}",
                        returnStdout: true
                    ).trim()
                    
                    if (status == 'true') {
                        echo "Container is running successfully"
                        // Show container logs
                        sh "docker logs ${CONTAINER_NAME}"
                    } else {
                        error "Container failed to start"
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "Deployment successful! Video2MD is available at http://localhost:${HOST_PORT}"
        }
        failure {
            echo "Deployment failed. Check the logs for details."
            // Optionally clean up failed container
            script {
                sh "docker rm -f ${CONTAINER_NAME} || true"
            }
        }
    }
}
